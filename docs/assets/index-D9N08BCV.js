(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function e(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=e(t);fetch(t.href,s)}})();function q(o,r){const{numLanes:e,heatsPerRacer:n,prioritize:t="lanes"}=r;if(!Array.isArray(o))throw new Error("racers must be an array");if(o.length===0)throw new Error("racers array cannot be empty");if(!Number.isInteger(e)||e<1)throw new Error("numLanes must be a positive integer");if(!Number.isInteger(n)||n<1)throw new Error("heatsPerRacer must be a positive integer");const s=o.length*n,l=Math.max(n,Math.ceil(s/e)),u=[];for(let c=0;c<l;c++){const d=new Array(e).fill(null);u.push(d)}const L=l*e-s,g=new Set;function w(c){const d=[];let a=0,f=c-1;for(;a<=f;)a===f?d.push(a):d.push(a,f),a++,f--;return d}const y=0,b=e-1;let v=0,$=0,C=u.length-1,x=0;const M=w(e);for(;x<L;){let c;v<$?c=y:$<v?c=b:c=x%2===0?y:b;let d=!1;for(const a of M){if(c===y&&a!==y||c===b&&a!==b)continue;const f=`${C},${a}`;if(!g.has(f)){g.add(f),a===y&&v++,a===b&&$++,x++,d=!0;break}}if(!d)for(const a of M){const f=`${C},${a}`;if(!g.has(f)){g.add(f),a===y&&v++,a===b&&$++,x++,d=!0;break}}C--,C<0&&(C=u.length-1)}const F=(c,d)=>g.has(`${c},${d}`),P=new Array(o.length).fill(n),E=o.map(()=>new Set),D=new Set,T=(c,d)=>c<d?`${c},${d}`:`${d},${c}`,N=[];for(let c=0;c<l;c++){const d=[];for(let a=0;a<e;a++)F(c,a)||d.push(a);N.push(d)}for(let c=0;c<l;c++){const d=N[c].length,a=[];for(let i=0;i<d;i++){const h=[];for(let p=0;p<o.length;p++)P[p]>0&&!a.includes(p)&&h.push(p);if(h.length===0)break;let m=h[0],S=-1/0;const O=N[c];for(const p of h){let A=0,z=0;for(const H of a)D.has(T(p,H))?z++:A++;let R=0;for(const H of O)E[p].has(H)||R++;const U=R>0?1:0;let I;t==="lanes"?I=U*1e3+R*50+A*5-z*20+P[p]:I=A*10-z*100+U*20+R*2+P[p],(I>S||I===S&&p<m)&&(S=I,m=p)}a.push(m),P[m]--}for(let i=0;i<a.length;i++)for(let h=i+1;h<a.length;h++)D.add(T(a[i],a[h]));const f=[...N[c]],j=a.map(i=>{for(let h=0;h<e;h++){const m=(i+E[i].size+h)%e;if(!E[i].has(m))return{racer:i,preferredLane:m}}return{racer:i,preferredLane:(i+E[i].size)%e}});j.sort((i,h)=>i.preferredLane!==h.preferredLane?i.preferredLane-h.preferredLane:i.racer-h.racer);for(const{racer:i,preferredLane:h}of j){let m;const S=f.indexOf(h);if(S>=0)m=h,f.splice(S,1);else if(f.length>0){let O=!1;for(let p=0;p<f.length;p++)if(!E[i].has(f[p])){m=f[p],f.splice(p,1),O=!0;break}O||(m=f.shift())}else continue;u[c][m]=o[i],E[i].add(m)}}return u}function K(){const o=document.getElementById("numLanes"),r=document.getElementById("heatsPerRacer");for(let e=2;e<=16;e++){const n=document.createElement("option");n.value=String(e),n.textContent=String(e),e===8&&(n.selected=!0),o.appendChild(n)}for(let e=1;e<=10;e++){const n=document.createElement("option");n.value=String(e),n.textContent=String(e),e===3&&(n.selected=!0),r.appendChild(n)}}function _(){const o=document.querySelectorAll(".toggle-btn"),r=document.getElementById("prioritize"),e=document.getElementById("lanes-explanation"),n=document.getElementById("opponents-explanation");o.forEach(t=>{t.addEventListener("click",()=>{o.forEach(l=>l.classList.remove("active")),t.classList.add("active");const s=t.dataset.value;r.value=s,s==="lanes"?(e.classList.remove("hidden"),n.classList.add("hidden")):(e.classList.add("hidden"),n.classList.remove("hidden"))})})}function G(o){const r=o.trim().split(`
`);if(r.length<2)return[];const e=r[0].split(/[,\t]/).map(t=>t.trim()),n=[];for(let t=1;t<r.length;t++){const s=r[t].split(/[,\t]/).map(u=>u.trim()),l={};e.forEach((u,L)=>{l[u]=s[L]||""}),n.push(l)}return n}function J(o){const r=new Map;for(const e of o){const n=e.Subgroup||"",t=e["Car#"]||"";!n||!t||(r.has(n)||r.set(n,[]),r.get(n).push({carNumber:t,subgroup:n}))}for(const[,e]of r)e.sort((n,t)=>n.carNumber.localeCompare(t.carNumber,void 0,{numeric:!0}));return r}function Q(o,r){const e=[];for(const[n,t]of o)try{const s=q(t,r);e.push({subgroup:n,heats:s})}catch(s){console.error(`Error scheduling ${n}:`,s)}return e}function W(o,r){return r.has(o)||r.set(o,r.size),`racer-${r.get(o)%48}`}function X(o,r){const e=document.getElementById("schedule-output"),n=new Map,t=Array.from({length:r},(l,u)=>`<th>Lane ${u+1}</th>`).join("");let s="";for(const{subgroup:l,heats:u}of o){s+=`<table class="schedule-table">
      <thead>
        <tr>${t}</tr>
      </thead>
      <tbody>
        <tr class="subgroup-row">
          <td colspan="${r}">${k(l)}</td>
        </tr>`;for(const L of u){s+="<tr>";for(let g=0;g<r;g++){const w=L[g];if(w===null)s+='<td class="bye-cell">Bye</td>';else{const y=W(w.carNumber,n);s+=`<td class="${y}">${k(w.carNumber)}</td>`}}s+="</tr>"}s+="</tbody></table>"}e.innerHTML=s}function Y(o,r){const e=[],n=Array.from({length:r},(t,s)=>`Lane ${s+1}`);e.push(n);for(const{heats:t}of o)for(const s of t){const l=[];for(let u=0;u<r;u++){const L=s[u];l.push(L?L.carNumber:"Bye")}e.push(l)}return e.map(t=>t.join(",")).join(`
`)}function Z(o){const r=document.getElementById("downloadLink"),e=new Blob([o],{type:"text/csv"}),n=URL.createObjectURL(e);r.href=n}function k(o){const r=document.createElement("div");return r.textContent=o,r.innerHTML}function B(o){const r=document.getElementById("schedule-output");r.innerHTML=`<div class="error-message">${k(o)}</div>`,document.getElementById("results").classList.remove("hidden")}function ee(o){o.preventDefault();const r=o.target,e=new FormData(r),n=e.get("inputCsv"),t=parseInt(e.get("numLanes"),10),s=parseInt(e.get("heatsPerRacer"),10),l=e.get("prioritize");if(!n.trim()){B("Please paste CSV data containing Subgroup and Car# columns.");return}const u=G(n);if(u.length===0){B("No valid data found. Please check your CSV format.");return}const L=u[0];if(!("Subgroup"in L)||!("Car#"in L)){B('CSV must contain "Subgroup" and "Car#" columns.');return}const g=J(u);if(g.size===0){B("No valid racers found. Each row needs a Subgroup and Car# value.");return}const y=Q(g,{numLanes:t,heatsPerRacer:s,prioritize:l});if(y.length===0){B("Failed to generate schedules. Please check your input data.");return}X(y,t);const b=Y(y,t);Z(b);const v=document.getElementById("results");v.classList.remove("hidden"),v.scrollIntoView({behavior:"smooth",block:"start"})}function V(){K(),_(),document.getElementById("scheduler-form").addEventListener("submit",ee)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V();
