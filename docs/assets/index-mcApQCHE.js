(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function e(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=e(t);fetch(t.href,a)}})();function Z(o,r){const{numLanes:e,heatsPerRacer:n,prioritize:t=["lanes","opponents","turnover"]}=r,a=Array.isArray(t)?t:t==="lanes"?["lanes","opponents","turnover"]:["opponents","lanes","turnover"],d={lanes:1,opponents:1,turnover:1},m=[1e3,100,10];for(let i=0;i<a.length;i++)d[a[i]]=m[i]??1;const y=["lanes","opponents","turnover"];for(const i of y)a.includes(i)||(d[i]=1);if(!Array.isArray(o))throw new Error("racers must be an array");if(o.length===0)throw new Error("racers array cannot be empty");if(!Number.isInteger(e)||e<1)throw new Error("numLanes must be a positive integer");if(!Number.isInteger(n)||n<1)throw new Error("heatsPerRacer must be a positive integer");const b=o.length*n,s=Math.max(n,Math.ceil(b/e)),l=[];for(let i=0;i<s;i++){const f=new Array(e).fill(null);l.push(f)}const v=s*e-b,w=new Set;function S(i){const f=[];let c=0,p=i-1;for(;c<=p;)c===p?f.push(c):f.push(c,p),c++,p--;return f}const E=0,I=e-1;let B=0,A=0,$=l.length-1,D=0;const M=S(e);for(;D<v;){let i;B<A?i=E:A<B?i=I:i=D%2===0?E:I;let f=!1;for(const c of M){if(i===E&&c!==E||i===I&&c!==I)continue;const p=`${$},${c}`;if(!w.has(p)){w.add(p),c===E&&B++,c===I&&A++,D++,f=!0;break}}if(!f)for(const c of M){const p=`${$},${c}`;if(!w.has(p)){w.add(p),c===E&&B++,c===I&&A++,D++,f=!0;break}}$--,$<0&&($=l.length-1)}const W=(i,f)=>w.has(`${i},${f}`),R=new Array(o.length).fill(n),C=o.map(()=>new Set),q=new Set,j=(i,f)=>i<f?`${i},${f}`:`${f},${i}`;let U=new Set;const O=[];for(let i=0;i<s;i++){const f=[];for(let c=0;c<e;c++)W(i,c)||f.push(c);O.push(f)}for(let i=0;i<s;i++){const f=O[i].length,c=[];for(let u=0;u<f;u++){const h=[];for(let g=0;g<o.length;g++)R[g]>0&&!c.includes(g)&&h.push(g);if(h.length===0)break;let L=h[0],P=-1/0;const H=O[i];for(const g of h){let F=0,K=0;for(const z of c)q.has(j(g,z))?K++:F++;let N=0;for(const z of H)C[g].has(z)||N++;const G=N>0?1:0,J=(U.has(g)?1:0)?-1:1,Q=(G*10+N)*d.lanes,X=(F*2-K*5)*d.opponents,Y=J*d.turnover,T=Q+X+Y+R[g]*.1;(T>P||T===P&&g<L)&&(P=T,L=g)}c.push(L),R[L]--}for(let u=0;u<c.length;u++)for(let h=u+1;h<c.length;h++)q.add(j(c[u],c[h]));U=new Set(c);const p=[...O[i]],V=c.map(u=>{for(let h=0;h<e;h++){const L=(u+C[u].size+h)%e;if(!C[u].has(L))return{racer:u,preferredLane:L}}return{racer:u,preferredLane:(u+C[u].size)%e}});V.sort((u,h)=>u.preferredLane!==h.preferredLane?u.preferredLane-h.preferredLane:u.racer-h.racer);for(const{racer:u,preferredLane:h}of V){let L;const P=p.indexOf(h);if(P>=0)L=h,p.splice(P,1);else if(p.length>0){let H=!1;for(let g=0;g<p.length;g++)if(!C[u].has(p[g])){L=p[g],p.splice(g,1),H=!0;break}H||(L=p.shift())}else continue;l[i][L]=o[u],C[u].add(L)}}return l}function ee(){const o=document.getElementById("numLanes"),r=document.getElementById("heatsPerRacer");for(let e=2;e<=16;e++){const n=document.createElement("option");n.value=String(e),n.textContent=String(e),e===8&&(n.selected=!0),o.appendChild(n)}for(let e=1;e<=10;e++){const n=document.createElement("option");n.value=String(e),n.textContent=String(e),e===3&&(n.selected=!0),r.appendChild(n)}}function te(){const o=document.getElementById("priority-list"),r=document.getElementById("prioritize");let e=null;function n(){const s=o.querySelectorAll(".priority-item"),l=[];s.forEach((v,w)=>{l.push(v.dataset.value);const S=v.querySelector(".priority-rank");S&&(S.textContent=String(w+1))}),r.value=l.join(",")}function t(s){e=s.target,e.classList.add("dragging"),s.dataTransfer&&(s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/html",e.innerHTML))}function a(){e&&(e.classList.remove("dragging"),e=null),o.querySelectorAll(".priority-item").forEach(s=>{s.classList.remove("drag-over")}),n()}function d(s){s.preventDefault(),s.dataTransfer&&(s.dataTransfer.dropEffect="move")}function m(s){const l=s.target.closest(".priority-item");l&&l!==e&&l.classList.add("drag-over")}function y(s){const l=s.target.closest(".priority-item");l&&l.classList.remove("drag-over")}function b(s){s.preventDefault();const l=s.target.closest(".priority-item");if(l&&e&&l!==e){const v=Array.from(o.querySelectorAll(".priority-item")),w=v.indexOf(e),S=v.indexOf(l);w<S?l.after(e):l.before(e)}o.querySelectorAll(".priority-item").forEach(v=>{v.classList.remove("drag-over")})}o.querySelectorAll(".priority-item").forEach(s=>{s.addEventListener("dragstart",t),s.addEventListener("dragend",a),s.addEventListener("dragover",d),s.addEventListener("dragenter",m),s.addEventListener("dragleave",y),s.addEventListener("drop",b)})}function re(o){const r=o.trim().split(`
`);if(r.length<2)return[];const e=r[0].split(/[,\t]/).map(t=>t.trim()),n=[];for(let t=1;t<r.length;t++){const a=r[t].split(/[,\t]/).map(m=>m.trim()),d={};e.forEach((m,y)=>{d[m]=a[y]||""}),n.push(d)}return n}function ne(o){const r=new Map;for(const e of o){const n=e.Subgroup||"",t=e["Car#"]||"";!n||!t||(r.has(n)||r.set(n,[]),r.get(n).push({carNumber:t,subgroup:n}))}for(const[,e]of r)e.sort((n,t)=>n.carNumber.localeCompare(t.carNumber,void 0,{numeric:!0}));return r}function oe(o,r){const e=[];for(const[n,t]of o)try{const a=Z(t,r);e.push({subgroup:n,heats:a})}catch(a){console.error(`Error scheduling ${n}:`,a)}return e}function se(o,r){return r.has(o)||r.set(o,r.size),`racer-${r.get(o)%48}`}function ae(o,r){const e=document.getElementById("schedule-output"),n=new Map,t=Array.from({length:r},(d,m)=>`<th>Lane ${m+1}</th>`).join("");let a="";for(const{subgroup:d,heats:m}of o){a+=`<table class="schedule-table">
      <thead>
        <tr>${t}</tr>
      </thead>
      <tbody>
        <tr class="subgroup-row">
          <td colspan="${r}">${k(d)}</td>
        </tr>`;for(const y of m){a+="<tr>";for(let b=0;b<r;b++){const s=y[b];if(s===null)a+='<td class="bye-cell">Bye</td>';else{const l=se(s.carNumber,n);a+=`<td class="${l}">${k(s.carNumber)}</td>`}}a+="</tr>"}a+="</tbody></table>"}e.innerHTML=a}function ie(o,r){const e=[],n=Array.from({length:r},(t,a)=>`Lane ${a+1}`);e.push(n);for(const{heats:t}of o)for(const a of t){const d=[];for(let m=0;m<r;m++){const y=a[m];d.push(y?y.carNumber:"Bye")}e.push(d)}return e.map(t=>t.join(",")).join(`
`)}function ce(o){const r=document.getElementById("downloadLink"),e=new Blob([o],{type:"text/csv"}),n=URL.createObjectURL(e);r.href=n}function k(o){const r=document.createElement("div");return r.textContent=o,r.innerHTML}function x(o){const r=document.getElementById("schedule-output");r.innerHTML=`<div class="error-message">${k(o)}</div>`,document.getElementById("results").classList.remove("hidden")}function le(o){o.preventDefault();const r=o.target,e=new FormData(r),n=e.get("inputCsv"),t=parseInt(e.get("numLanes"),10),a=parseInt(e.get("heatsPerRacer"),10),m=e.get("prioritize").split(",");if(!n.trim()){x("Please paste CSV data containing Subgroup and Car# columns.");return}const y=re(n);if(y.length===0){x("No valid data found. Please check your CSV format.");return}const b=y[0];if(!("Subgroup"in b)||!("Car#"in b)){x('CSV must contain "Subgroup" and "Car#" columns.');return}const s=ne(y);if(s.size===0){x("No valid racers found. Each row needs a Subgroup and Car# value.");return}const v=oe(s,{numLanes:t,heatsPerRacer:a,prioritize:m});if(v.length===0){x("Failed to generate schedules. Please check your input data.");return}ae(v,t);const w=ie(v,t);ce(w);const S=document.getElementById("results");S.classList.remove("hidden"),S.scrollIntoView({behavior:"smooth",block:"start"})}function _(){ee(),te(),document.getElementById("scheduler-form").addEventListener("submit",le)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_();
