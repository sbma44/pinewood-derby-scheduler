(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function e(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=e(t);fetch(t.href,a)}})();function X(o,n){const{numLanes:e,heatsPerRacer:r,prioritize:t=["lanes","turnover","opponents"]}=n,a=Array.isArray(t)?t:t==="lanes"?["lanes","turnover","opponents"]:["opponents","turnover","lanes"],u={lanes:1,opponents:1,turnover:1},f=[1e3,100,10];for(let i=0;i<a.length;i++)u[a[i]]=f[i]??1;const h=["lanes","opponents","turnover"];for(const i of h)a.includes(i)||(u[i]=1);if(!Array.isArray(o))throw new Error("racers must be an array");if(o.length===0)throw new Error("racers array cannot be empty");if(!Number.isInteger(e)||e<1)throw new Error("numLanes must be a positive integer");if(!Number.isInteger(r)||r<1)throw new Error("heatsPerRacer must be a positive integer");const y=o.length*r,s=Math.max(r,Math.ceil(y/e)),l=[];for(let i=0;i<s;i++){const d=new Array(e).fill(null);l.push(d)}const g=s*e-y,v=new Set;function S(i){const d=[];let c=0,p=i-1;for(;c<=p;)c===p?d.push(c):d.push(c,p),c++,p--;return d}const L=0,E=e-1;let P=0,B=0,C=l.length-1,x=0;const T=S(e);for(;x<g;){let i;P<B?i=L:B<P?i=E:i=x%2===0?L:E;let d=!1;for(const c of T){if(i===L&&c!==L||i===E&&c!==E)continue;const p=`${C},${c}`;if(!v.has(p)){v.add(p),c===L&&P++,c===E&&B++,x++,d=!0;break}}if(!d)for(const c of T){const p=`${C},${c}`;if(!v.has(p)){v.add(p),c===L&&P++,c===E&&B++,x++,d=!0;break}}C--,C<0&&(C=l.length-1)}const V=(i,d)=>v.has(`${i},${d}`),A=new Array(o.length).fill(r),R=o.map(()=>new Set),N=new Set,z=(i,d)=>i<d?`${i},${d}`:`${d},${i}`;let M=new Set;const k=[];for(let i=0;i<s;i++){const d=[];for(let c=0;c<e;c++)V(i,c)||d.push(c);k.push(d)}for(let i=0;i<s;i++){const d=k[i],c=[],p=[...d];for(let w=0;w<i%d.length;w++)p.push(p.shift());for(const w of p){const b=[];for(let m=0;m<o.length;m++)A[m]>0&&!c.includes(m)&&b.push(m);if(b.length===0)break;let I=b[0],O=-1/0;for(const m of b){const F=R[m].has(w)?0:10;let q=0,j=0;for(const W of c)N.has(z(m,W))?j++:q++;const K=q*2-j*5,_=M.has(m)?-1:1,G=F*u.lanes,J=K*u.opponents,Q=_*u.turnover,D=G+J+Q+A[m]*.1;(D>O||D===O&&m<I)&&(O=D,I=m)}l[i][w]=o[I],c.push(I),A[I]--,R[I].add(w)}for(let w=0;w<c.length;w++)for(let b=w+1;b<c.length;b++)N.add(z(c[w],c[b]));M=new Set(c)}return l}function Y(){const o=document.getElementById("numLanes"),n=document.getElementById("heatsPerRacer");for(let e=2;e<=16;e++){const r=document.createElement("option");r.value=String(e),r.textContent=String(e),e===8&&(r.selected=!0),o.appendChild(r)}for(let e=1;e<=10;e++){const r=document.createElement("option");r.value=String(e),r.textContent=String(e),e===3&&(r.selected=!0),n.appendChild(r)}}function Z(){const o=document.getElementById("priority-list"),n=document.getElementById("prioritize");let e=null;function r(){const s=o.querySelectorAll(".priority-item"),l=[];s.forEach((g,v)=>{l.push(g.dataset.value);const S=g.querySelector(".priority-rank");S&&(S.textContent=String(v+1))}),n.value=l.join(",")}function t(s){e=s.target,e.classList.add("dragging"),s.dataTransfer&&(s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/html",e.innerHTML))}function a(){e&&(e.classList.remove("dragging"),e=null),o.querySelectorAll(".priority-item").forEach(s=>{s.classList.remove("drag-over")}),r()}function u(s){s.preventDefault(),s.dataTransfer&&(s.dataTransfer.dropEffect="move")}function f(s){const l=s.target.closest(".priority-item");l&&l!==e&&l.classList.add("drag-over")}function h(s){const l=s.target.closest(".priority-item");l&&l.classList.remove("drag-over")}function y(s){s.preventDefault();const l=s.target.closest(".priority-item");if(l&&e&&l!==e){const g=Array.from(o.querySelectorAll(".priority-item")),v=g.indexOf(e),S=g.indexOf(l);v<S?l.after(e):l.before(e)}o.querySelectorAll(".priority-item").forEach(g=>{g.classList.remove("drag-over")})}o.querySelectorAll(".priority-item").forEach(s=>{s.addEventListener("dragstart",t),s.addEventListener("dragend",a),s.addEventListener("dragover",u),s.addEventListener("dragenter",f),s.addEventListener("dragleave",h),s.addEventListener("drop",y)})}function ee(o){const n=o.trim().split(`
`);if(n.length<2)return[];const e=n[0].split(/[,\t]/).map(t=>t.trim()),r=[];for(let t=1;t<n.length;t++){const a=n[t].split(/[,\t]/).map(f=>f.trim()),u={};e.forEach((f,h)=>{u[f]=a[h]||""}),r.push(u)}return r}function te(o){const n=new Map;for(const e of o){const r=e.Subgroup||"",t=e["Car#"]||"";!r||!t||(n.has(r)||n.set(r,[]),n.get(r).push({carNumber:t,subgroup:r}))}for(const[,e]of n)e.sort((r,t)=>r.carNumber.localeCompare(t.carNumber,void 0,{numeric:!0}));return n}function ne(o,n){const e=[];for(const[r,t]of o)try{const a=X(t,n);e.push({subgroup:r,heats:a})}catch(a){console.error(`Error scheduling ${r}:`,a)}return e}function re(o,n){return n.has(o)||n.set(o,n.size),`racer-${n.get(o)%48}`}function oe(o,n){const e=document.getElementById("schedule-output"),r=new Map,t=Array.from({length:n},(u,f)=>`<th>Lane ${f+1}</th>`).join("");let a="";for(const{subgroup:u,heats:f}of o){a+=`<table class="schedule-table">
      <thead>
        <tr>${t}</tr>
      </thead>
      <tbody>
        <tr class="subgroup-row">
          <td colspan="${n}">${H(u)}</td>
        </tr>`;for(const h of f){a+="<tr>";for(let y=0;y<n;y++){const s=h[y];if(s===null)a+='<td class="bye-cell">Bye</td>';else{const l=re(s.carNumber,r);a+=`<td class="${l}">${H(s.carNumber)}</td>`}}a+="</tr>"}a+="</tbody></table>"}e.innerHTML=a}function se(o,n){const e=[],r=Array.from({length:n},(t,a)=>`Lane ${a+1}`);e.push(r);for(const{heats:t}of o)for(const a of t){const u=[];for(let f=0;f<n;f++){const h=a[f];u.push(h?h.carNumber:"Bye")}e.push(u)}return e.map(t=>t.join(",")).join(`
`)}function ae(o){const n=document.getElementById("downloadLink"),e=new Blob([o],{type:"text/csv"}),r=URL.createObjectURL(e);n.href=r}function H(o){const n=document.createElement("div");return n.textContent=o,n.innerHTML}function $(o){const n=document.getElementById("schedule-output");n.innerHTML=`<div class="error-message">${H(o)}</div>`,document.getElementById("results").classList.remove("hidden")}function ie(o){o.preventDefault();const n=o.target,e=new FormData(n),r=e.get("inputCsv"),t=parseInt(e.get("numLanes"),10),a=parseInt(e.get("heatsPerRacer"),10),f=e.get("prioritize").split(",");if(!r.trim()){$("Please paste CSV data containing Subgroup and Car# columns.");return}const h=ee(r);if(h.length===0){$("No valid data found. Please check your CSV format.");return}const y=h[0];if(!("Subgroup"in y)||!("Car#"in y)){$('CSV must contain "Subgroup" and "Car#" columns.');return}const s=te(h);if(s.size===0){$("No valid racers found. Each row needs a Subgroup and Car# value.");return}const g=ne(s,{numLanes:t,heatsPerRacer:a,prioritize:f});if(g.length===0){$("Failed to generate schedules. Please check your input data.");return}oe(g,t);const v=se(g,t);ae(v);const S=document.getElementById("results");S.classList.remove("hidden"),S.scrollIntoView({behavior:"smooth",block:"start"})}function U(){Y(),Z(),document.getElementById("scheduler-form").addEventListener("submit",ie)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U):U();
